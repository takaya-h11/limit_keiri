# テスト手順ガイド

アップデートされたシステムのテスト方法を説明します。

---

## 前提条件

1. **Renderへのデプロイ完了**
   - GitHubにプッシュ後、Renderが自動的にデプロイを開始します
   - Render Dashboard → Logs で「Application startup complete」を確認

2. **スプレッドシートに「テンプレート」シートを作成**
   - 「四ツ谷　2026年店舗管理シート」を開く
   - 既存の月次シート（例：「12 月度」）を複製
   - シート名を「テンプレート」に変更
   - ヘッダー行（4行目）とフォーマットが正しいことを確認

---

## テスト1: ヘルスチェック

### 目的
デプロイが成功し、Google Sheets接続が正常であることを確認

### 手順

```bash
curl https://limit-keiri.onrender.com/health
```

### 期待される出力

```json
{
  "status": "healthy",
  "google_sheets": "connected",
  "spreadsheet": "四ツ谷　2026年店舗管理シート"
}
```

---

## テスト2: 既存シートへの書き込み

### 目的
現在の月のシートが既に存在する場合の動作確認

### 前提条件
- 現在の月のシート（例：「1 月度」）がスプレッドシートに存在すること

### 手順

```bash
curl -X POST https://limit-keiri.onrender.com/api/record_sale \
  -H "Content-Type: application/json" \
  -d '{
    "day": 1,
    "seller": "服部誉也",
    "payment_method": "PayPal",
    "product_name": "月4回プラン",
    "quantity": 1,
    "unit_price_excl_tax": 32000
  }'
```

### 期待される出力

```json
{
  "success": true,
  "row": 5,
  "message": "売上を 5 行目に記録しました",
  "sheet_name": "1 月度"
}
```

### Renderログの確認

Render Dashboard → Logs で以下が出力されることを確認：

```
================================================================================
[API] POST /api/record_sale - リクエスト受信
[リクエストデータ] {'day': 1, 'seller': '服部誉也', 'payment_method': 'PayPal', ...}
[処理開始] Google Sheetsクライアントを取得しました
[売上記録開始] day=1, seller=服部誉也, payment_method=PayPal, ...
[シート取得] 対象シート名: 1 月度
[シート取得成功] シート '1 月度' を開きました
[接続先] スプレッドシート: '四ツ谷　2026年店舗管理シート', シート名: '1 月度'
[書き込み先] 次の空行: 5 行目
[書き込みデータ] C列〜J列: [1, '服部誉也', 'PayPal', '月4回プラン', 1, 32000, 32000, 3200]
[計算結果] 小計（税抜）=32000, 消費税=3200
[書き込み範囲] C5:J5
[書き込み成功] 5 行目に売上を記録しました
[API成功] 売上を 5 行目に記録しました (シート: 1 月度)
================================================================================
```

### スプレッドシートの確認

- 「1 月度」シートを開く
- 5行目（または次の空行）のC列〜J列にデータが記録されていることを確認
- I列（小計）= 1 × 32,000 = 32,000
- J列（消費税）= 32,000 × 0.1 = 3,200

---

## テスト3: シート自動作成（重要）

### 目的
月次シートが存在しない場合、テンプレートから自動作成されることを確認

### 準備
1. テスト用に、スプレッドシートから「1 月度」シートを**一時的に削除**
2. 「テンプレート」シートが存在することを確認

### 手順

```bash
curl -X POST https://limit-keiri.onrender.com/api/record_sale \
  -H "Content-Type: application/json" \
  -d '{
    "day": 1,
    "seller": "服部誉也",
    "payment_method": "PayPal",
    "product_name": "月4回プラン",
    "quantity": 1,
    "unit_price_excl_tax": 32000
  }'
```

### 期待される動作

1. **シートが自動作成される**
   - 「1 月度」シートがスプレッドシートに新規作成される
   - 「テンプレート」シートの内容が複製される

2. **データが記録される**
   - 新しく作成された「1 月度」シートの5行目にデータが記録される

### Renderログの確認

```
================================================================================
[API] POST /api/record_sale - リクエスト受信
[リクエストデータ] {'day': 1, 'seller': '服部誉也', ...}
[処理開始] Google Sheetsクライアントを取得しました
[売上記録開始] day=1, seller=服部誉也, ...
[シート取得] 対象シート名: 1 月度
[シート未検出] シート '1 月度' が見つかりません。テンプレートから作成します。
[テンプレート取得成功] 'テンプレート' シートを取得しました
[シート作成成功] '1 月度' シートを作成しました（テンプレートID: 123456789）
[接続先] スプレッドシート: '四ツ谷　2026年店舗管理シート', シート名: '1 月度'
[書き込み先] 次の空行: 5 行目
[書き込みデータ] C列〜J列: [1, '服部誉也', 'PayPal', '月4回プラン', 1, 32000, 32000, 3200]
[計算結果] 小計（税抜）=32000, 消費税=3200
[書き込み範囲] C5:J5
[書き込み成功] 5 行目に売上を記録しました
[API成功] 売上を 5 行目に記録しました (シート: 1 月度)
================================================================================
```

### スプレッドシートの確認

- **新しいシート「1 月度」が作成されている**
- テンプレートと同じフォーマット（ヘッダー行など）
- 5行目のC列〜J列にデータが記録されている
- I列（小計）= 32,000、J列（消費税）= 3,200

---

## テスト4: エラーハンドリング（テンプレートなし）

### 目的
「テンプレート」シートが存在しない場合のエラー処理を確認

### 準備
1. スプレッドシートから「テンプレート」シートを**一時的に削除**
2. テスト用の月次シート（例：「1 月度」）も削除

### 手順

```bash
curl -X POST https://limit-keiri.onrender.com/api/record_sale \
  -H "Content-Type: application/json" \
  -d '{
    "day": 1,
    "seller": "服部誉也",
    "payment_method": "PayPal",
    "product_name": "月4回プラン",
    "quantity": 1,
    "unit_price_excl_tax": 32000
  }'
```

### 期待される出力

```json
{
  "detail": "テンプレートシートが見つかりません。スプレッドシートに 'テンプレート' という名前のシートを作成してください。"
}
```

### Renderログの確認

```
================================================================================
[API] POST /api/record_sale - リクエスト受信
[リクエストデータ] {'day': 1, ...}
[処理開始] Google Sheetsクライアントを取得しました
[売上記録開始] day=1, ...
[シート取得] 対象シート名: 1 月度
[シート未検出] シート '1 月度' が見つかりません。テンプレートから作成します。
[テンプレート未検出] 'テンプレート' シートが見つかりません。...
[API例外] エラーが発生しました: テンプレートシートが見つかりません...
================================================================================
```

### 復旧
- スプレッドシートに「テンプレート」シートを再作成
- テスト3を再実行して正常動作を確認

---

## テスト5: Google Apps Scriptからの実行

### 目的
スマホからの実際の運用フローを確認

### 手順

1. **Google Sheetsを開く**
2. **メニュー → 売上管理 → 売上を記録**
3. 以下のテキストを貼り付け：
   ```
   1/2 PayPalで月4回プラン 35,200円 販売しました。販売者: 服部誉也
   ```
4. **OK** をクリック

### 期待される動作

1. Gemini APIがテキストを解析
2. APIサーバーに売上データを送信
3. スプレッドシートに記録
4. 成功メッセージが表示される

---

## トラブルシューティング

### シートが作成されない

**原因:**
- 「テンプレート」シートが存在しない
- スプレッドシートの編集権限がない

**解決策:**
1. スプレッドシートに「テンプレート」という名前のシートを作成
2. サービスアカウントに編集権限があることを確認

### ログが表示されない

**原因:**
- Renderのデプロイが完了していない
- ログレベルが適切でない

**解決策:**
1. Render Dashboard → Logs で「Application startup complete」を確認
2. 環境変数 `LOG_LEVEL=INFO` が設定されていることを確認

### 書き込みが5行目ではなく別の行になる

**原因:**
- 既に他のデータが記録されている

**解決策:**
- 正常な動作です。システムは自動的に次の空行を検索します
- Renderログで「[書き込み先] 次の空行: X 行目」を確認

---

## チェックリスト

デプロイ後、以下を確認してください：

- [ ] ヘルスチェックが成功する
- [ ] 既存シートへの書き込みが成功する
- [ ] シート自動作成が動作する（テスト3）
- [ ] Renderログに詳細な情報が出力される
- [ ] スプレッドシートのC列〜J列にデータが正しく記録される
- [ ] I列（小計）とJ列（消費税）が正しく計算されている
- [ ] Google Apps Scriptから売上記録ができる

---

## 参考資料

- [Renderログの確認方法](https://render.com/docs/logs)
- [Google Apps Script設定](../docs/ai-studio-setup.md)
- [システムアーキテクチャ](../ARCHITECTURE.md)
